name: Xodium CI/CD

on:
  push:
    branches: [ main, dev ]
    paths: [ "src/**" ]
  workflow_dispatch:

permissions:
  contents: write
  packages: write

concurrency:
  group: "${{ github.workflow }}-${{ github.ref }}"
  cancel-in-progress: true

jobs:
  build:
    if: "!contains(github.event.head_commit.message, '[ci-skip]')"
    runs-on: ubuntu-latest
    environment:
      name: "${{ github.ref_name }}"
      url: "${{ steps.upload_artifact.outputs.artifact-url }}"
    outputs:
      VERSION: "${{ steps.set_version.outputs.VERSION }}"
    steps:
      - id: checkout
        name: Checkout
        uses: actions/checkout@v5.0.0
        with:
          fetch-depth: 0

      - id: setup_java
        name: Setup Java
        uses: actions/setup-java@v5.0.0
        with:
          distribution: temurin
          java-version: "21"

      - id: setup_gradle
        name: Setup Gradle
        uses: gradle/actions/setup-gradle@83c124bfb09badf85ddfbf01158b5592c1a78c4a

      - id: set_version
        name: Set Version
        run: |
          base_version=$(grep -oP '(?<=^version: ).*' src/main/resources/paper-plugin.yml | tr -d \''"')
          if [ "${{ github.ref_name }}" = "dev" ]; then
            build_number=$(git rev-list --count HEAD)
            VERSION="${base_version}-${build_number}"
            echo "Calculated dev version: $VERSION"
          else
            VERSION="${base_version}"
            echo "Calculated main version: $VERSION"
          fi
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT

      - id: build_artifact
        name: Build Artifact
        run: ./gradlew shadowJar -PbuildVersion=${{ steps.set_version.outputs.VERSION }}

      - id: upload_artifact
        name: Upload Artifact
        uses: actions/upload-artifact@v4.6.2
        with:
          name: vanillaplus
          path: build/libs/VanillaPlus-*.jar

  release:
    needs: [ build ]
    if: github.ref_name == 'main' || github.ref_name == 'dev'
    runs-on: ubuntu-latest
    environment:
      name: "${{ github.ref_name }}"
      url: "${{ steps.release_artifact.outputs.url }}"
    steps:
      - id: download_artifact
        name: Download Artifact
        uses: actions/download-artifact@v5.0.0
        with: { name: vanillaplus }

      - id: release_artifact
        name: Release Artifact
        uses: softprops/action-gh-release@fbadcc90e88ecface60a0a0d123795b784ceb239
        env:
          GITHUB_TOKEN: "${{ secrets.GITHUB_TOKEN }}"
        with:
          generate_release_notes: true
          prerelease: ${{ github.ref_name == 'dev' }}
          tag_name: ${{ needs.build.outputs.VERSION }}
          files: VanillaPlus-*.jar

  deploy:
    needs:
      - build
      - release
    runs-on: ubuntu-latest
    if: github.ref_name == 'main'
    environment:
      name: ${{ github.ref_name }}
    steps:
      - id: download_artifact
        name: Download Artifact
        uses: actions/download-artifact@v5.0.0
        with: { name: vanillaplus }

      - id: uts
        name: Upload to Server
        uses: appleboy/scp-action@eb443bd4941c3334ee584c1915fcfa2001e8a86c
        with:
          host: ${{ secrets.SFTP_HOST }}
          username: ${{ secrets.SFTP_USER }}
          password: ${{ secrets.SFTP_PASSWORD }}
          port: ${{ secrets.SFTP_PORT }}
          source: "VanillaPlus-*.jar"
          target: ${{ secrets.SFTP_MCS_PLUGINS_UPDATE_FOLDER_PATH }}/
